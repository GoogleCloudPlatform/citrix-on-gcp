#
#  Copyright 2019 Google Inc.
#
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.
#

{% macro random_alphanum(len) %}{% for n in range(len) %}{{ ['0','1','2','3','4','5','6','7','8','9','a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z']|random }}{% endfor %}{% endmacro %}

outputs:
- name: GCS Bucket
  value: $(ref.bucket.name)
- name: Suffix
  value: $(ref.citrix-on-gcp-lab.suffix)
- name: Deployment
  value: $(ref.citrix-on-gcp-lab.deployment)
- name: Domain
  value: $(ref.citrix-on-gcp-lab.domain)
- name: NetBIOS Name
  value: $(ref.citrix-on-gcp-lab.netbios-name)
- name: Domain Admin
  value: $(ref.citrix-on-gcp-lab.administrator)

resources:
- name: citrix-on-gcp-lab
  type: citrix-on-gcp.jinja
  properties:
    admin: user:{{ properties['userName'] }}@qwiklabs.net
    ssd: True
    minimal: False
    admin-service-account: {{ env['project_number'] }}-compute@developer.gserviceaccount.com
    netbios-name: SYNERGY
{% if properties['suffix'] %}
    domain-name: synergy-{{ properties['suffix'] }}.com
    suffix: {{ properties['suffix'] }}
{% else %}
{% set suffix = random_alphanum(3) %}
    domain-name: synergy-{{ suffix }}.com
    suffix: {{ suffix }}
{% endif %}
{% if properties['vdas'] %}
    workers: {{ properties['vdas'] }}
{% else %}
    workers: 0
{% endif %}
{% if properties['citrix-creds'] %}
    citrix-creds: {{ properties['citrix-creds'] }}
{% endif %}
{% if properties['resource-location-id'] %}
    resource-location-id: {{ properties['resource-location-id'] }}
{% endif %}

